<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>MMU SOUL · {{'Create Post' if mode=='create' else 'Edit Post'}}</title>
</head>
<body>
    <header style="justify-content: center;">
        <div>MMU SOUL · FORUM</div>
        <button class="back-btn" onclick="window.history.back()">
            <i class="fas fa-arrow-left"></i>
        </button>
    </header>

    <div class="form-card">
        <h2>{{'Create a new post' if mode=='create' else 'Edit Post'}}</h2>
        <form id="post-form" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" name="title" placeholder="Enter post title" value="{{post.title if post else''}}" required>
            </div>

            <div class="form-group">
                <label for="content">Content</label>
                <textarea name="content" placeholder="Write your content here....." required>{{post.content if post else ''}}</textarea>
            </div>

            <div class="form-group">
                <label for="tags">Tags</label>
                <input type="text" name="tags" value="{{existing_tags if existing_tags else ''}}" placeholder="#mmu">
            </div>

            <div class="upload-box">
                <input type="file" id="media" name="media" multiple accept="image/*,video/*" hidden>
                <label for="media" class="upload-label">
                    <span>Upload your video or photo</span>
                </label>
            </div>

            <div class="preview-container" id="preview-container">
                {% if post and post.media %}
                    {% for media in post.media %}
                        <div class="media-preview">
                            {% if media.media_url.endswith(('.png','.jpg','.jpeg','.gif')) %}
                                <img src="{{ url_for('static', filename=media.media_url) }}">
                            {% else %}
                                <video src="{{ url_for('static', filename=media.media_url) }}" controls></video>
                            {% endif %}
                            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
    </div>

<script>
//--------- Binding-----------------
const fileInput = document.getElementById("media"); 
const previewContainer = document.getElementById("preview-container");

let dt = new DataTransfer();

//--------File selection event----------
fileInput.addEventListener("change", function(e) {
    const newFiles = Array.from(e.target.files);

    newFiles.forEach((file) => {
        const fileURL = URL.createObjectURL(file);

        const wrapper = document.createElement("div");
        wrapper.classList.add("media-preview");

        //----------Determine the file type and generate a preview-----
        if (file.type.startsWith("image/")) {
            const img = document.createElement("img");
            img.src = fileURL;
            wrapper.appendChild(img);
        } else if (file.type.startsWith("video/")) {
            const video = document.createElement("video");
            video.src = fileURL;
            video.controls = true;
            wrapper.appendChild(video);
        }

        //---------------Add a delete button for media----
        const removeBtn = document.createElement("button");
        removeBtn.innerHTML = "×";
        removeBtn.classList.add("remove-btn");
        removeBtn.onclick = function() {
            wrapper.remove();

            const index = Array.from(dt.files).indexOf(file);
            if (index > -1) {
                dt.items.remove(index);
            }
            fileInput.files = dt.files;
        };

        wrapper.appendChild(removeBtn);
        previewContainer.appendChild(wrapper);

        dt.items.add(file);
    });

    fileInput.files = dt.files;
});

</script>
</body>
</html>
