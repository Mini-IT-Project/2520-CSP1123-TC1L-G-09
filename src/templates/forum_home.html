<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" defer></script>
    <title>MMU SOUL · FORUM</title>
</head>
<body>
    <header>
        MMU SOUL · FORUM
        <div class="search-section">
            <form class="search-container" action="{{ url_for('forum.homepage') }}" method="get">
                <input
                    name="q"
                    value="{{ q|default('') }}"
                    placeholder="Search posts or #tags..."
                />
                <button type="submit">Search</button>
            </form>
        </div>
    </header>

    <main>
        <section id="feed">
            {% if tag %}
                <h2 class="muted">Showing #{{ tag }}</h2>
            {% elif q %}
                <h2 class="muted">Search: "{{ q }}"</h2>
            {% endif %}

            {% for p in posts or [] %}
            <article class="card post" id="post-{{ p.id }}">
                <header class="post-header">
                    <h3>
                        <a href="{{ url_for('forum.post_detail', post_id=p.id) }}">{{ p.title }}</a>
                    </h3>
                    <div class="muted">
                        {{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '' }}
                    </div>
                </header>

                <div class="post-body">
                    <p>{{ p.content }}</p>

                    {% if p.media_url %}
                        {# 先轉小寫再判斷副檔名，避免 None 或大小寫問題 #}
                        {% set _m = p.media_url.lower() %}
                        {% if _m.endswith('.png') or _m.endswith('.jpg') or _m.endswith('.jpeg') or _m.endswith('.gif') %}
                            <img class="media" src="{{ p.media_url }}" alt="image" />
                        {% else %}
                            <video class="media" controls>
                                <source src="{{ p.media_url }}" />
                            </video>
                        {% endif %}
                    {% endif %}
                </div>

                <div class="tags">
                    {% for t in p.tags or [] %}
                        <a class="tag" href="{{ url_for('forum.homepage', tag=t.name) }}">#{{ t.name }}</a>
                    {% endfor %}
                </div>

                <footer class="post-actions">
                    <button type="button" class="icon-btn like-btn" data-id="{{ p.id }}">
                        👍🏻<span class="like-count">{{ p.like_count }}</span>
                    </button>

                    <a class="icon-btn comment-btn" href="{{ url_for('forum.post_detail', post_id=p.id) }}#comments">
                        💬<span class="comment-count">{{ p.comment_count }}</span>
                    </a>

                    <button type="button" class="icon-btn share-btn" data-url="{{ url_for('forum.post_detail', post_id=p.id, _external=True) }}">
                        🔗
                    </button>

                    <a class="icon-btn report-btn" href="{{ url_for('forum.report_post', post_id=p.id) }}">🚩</a>
                </footer>
            </article>
            {% else %}
                <p class="muted">No post yet. Be the first to share something! 🎉</p>
            {% endfor %}
        </section>
    </main>

    <a class="floating-btn" href="{{ url_for('forum.create_post') }}">
        <span>+</span>
        <span class="tooltip">Create new post</span>
    </a>
</body>
</html>
