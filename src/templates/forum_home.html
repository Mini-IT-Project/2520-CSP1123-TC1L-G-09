<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <title>MMU FORUM</title>
</head>
<body>
    <header>
        <a href="{{url_for('main.homepage')}}" style="position: absolute; left: 80px; transform: translateX(-50%); top: -10px;">
            <img src="{{url_for('static', filename='ebeemmu.png')}}" alt="logo" width="150" height="105" style="margin-left: 10px;">
        </a>
        <div style="color: white; position: absolute; left: 130px; top: 70px; font-size: 18px;">Back</div>
        MMU FORUM
        <nav>
            <ul>
                <li><a href="{{ url_for('forum.homepage') }}">Forum</a></li>
                <li><a href="{{ url_for('MatchChat.home') }}">Match Chat</a></li>
                <li><a href="{{ url_for('bottle.DriftingBottle') }}">Drifting Bottle</a></li>
                <li><a href="{{ url_for('profile.myProfile') }}">Profile</a></li>
                <li>
                {% if 'user_id' in session %}
                <span style="color: rgb(255, 255, 255); font-weight: bold;">Welcome</span>
                {% else %}
                <a href="{{ url_for('login.home') }}" class="homepage-login">Login</a>
                {% endif %}
                </li>
            </ul>
        </nav>
    </header>

    <form class="search-container" action="{{ url_for('forum.homepage') }}" method="get">
        <input
            name="q"
            value="{{ q|default('') }}"
            placeholder="Search posts or #tags..."
        />
        <button type="submit">Search</button>
    </form>

    <main>
        <section id="feed">
            {% for p in posts or [] %}
            <article class="post-card">
                <div class="post-meta">
                    <img src="{{url_for('static',filename='avatar' ~ (p.author_profile.avatar_type if p.author_profile and p.author_profile else 0)~'.png')}}" class="avatar" alt="avatar" 
                    style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                    <div class="meta-text">
                        <h3 class="post-author">
                            <strong>{{p.author_profile.degree_name if p.author_profile else ''}} {{p.author_profile.faculty_name if p.author_profile else 'Anonymous'}}</strong>
                        </h3>
                        <h3 class="post-title"><a href="{{url_for('forum.post_detail',post_id=p.id)}}">{{p.title}}</a></h3>
                        <span class="timestamp">{{p.created_at.strftime('%Y-%m-%d %H:%M')}}</span>
                    </div>
                </div>

                <div class="post-content">
                    <p class="post-excerpt">
                        {{ p.content[:100] }}{% if p.content|length > 100 %}...{% endif %}
                    </p>
                </div>

                {% if p.media %}
                <div class="post-media">
                    {% for m in p.media %}
                    {% if m.media_url.endswith('.png') or m.media_url.endswith('.jpg') or m.media_url.endswith('.jpeg') or m.media_url.endswith('.gif') %}
                        <img class="media" src="{{m.media_url}}" alt="image" />
                    {% else %}
                        <video class="media" controls>
                            <source src="{{m.media_url}}" />
                        </video>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                <div class="spacer"></div>

                <div class="tags">
                    {% for t in p.tags or [] %}
                    <a class="tag" href="{{url_for('forum.homepage',tag=t.name)}}">#{{t.name}}</a>
                    {% endfor %}
                </div>

                <div class="post-actions">
                    <button type="button" class="icon-btn like-btn" data-id="{{ p.id }}">
                        üëçüèª<span class="like-count">{{ p.like_count()}}</span>
                    </button>

                    <button type="button" class="icon-btn comment-btn" href="{{ url_for('forum.post_detail', post_id=p.id) }}#comments">
                        üí¨<span class="comment-count">{{ p.comment_count()}}</span>
                    </a>

                    <button type="button" class="icon-btn share-btn" data-url="{{ url_for('forum.post_detail', post_id=p.id, _external=True) }}">
                        üîó<span class="share-count">Share</span>
                    </button>
                </div>

            </article>
            {% else %}
            <p class="muted">No post yet. Be the first to share something! üéâ</p>
            {% endfor %}
        </section>
    </main>

    <a class="floating-btn" href="{{ url_for('forum.create_post') }}">
        <span>+</span>
        <span class="tooltip">Create new post</span>
    </a>
<script>
    document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".like-btn").forEach(button => {
        button.addEventListener("click", () => {
            const postId = button.getAttribute("data-id");

            fetch(`/forum/post/${postId}/like`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({})
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    const countSpan = button.querySelector(".like-count");
                    if (countSpan) countSpan.textContent = data.likes;
                } else {
                    alert(data.error || "Like failed.");
                }
            })
            .catch(err => console.error("Like error:", err));
        });
    });

    if (typeof io !== "undefined") {
        const socket = io();
        socket.on("like_updates", function(data) {
            const buttonEl = document.querySelector(`.like-btn[data-id="${data.post_id}"]`);
            if (buttonEl) {
                const countSpan = buttonEl.querySelector(".like-count");
                if (countSpan) countSpan.textContent = data.likes;
            }
        });
    }
});

</script>
</body>
</html>
