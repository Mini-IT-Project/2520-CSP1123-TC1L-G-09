<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <title>MMU FORUM</title>
</head>
<body>
<article class="card post">
    <header class="post-header">
        <div style="display: flex; align-items: center;gap: 10px;">
            <img src="{{url_for('static', filename='avatar' ~ (author_profile.avatar_type if author_profile else 0) ~ '.png')}}" 
            alt="avatar" style="width: 40px; height:40px; border-radius: 50%; object-fit: cover;">
            <div style="display:flex;flex-direction: column;gap:2px;" >
                <span class="post-author">
                    {{author_profile.degree_name if author_profile else ''}} IN {{author_profile.faculty_name if author_profile else ''}}
                </span>
                <span class="post-timestamp">
                    {{post.created_at.strftime('%Y-%m-%d %H:%M')}}
                </span>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropdown-toggle">‚ãÆ</button>
            <div class="dropdown-menu">
                {% if session.get("user_id") == post.user_id %}
                <a href="{{url_for('forum.edit_post', post_id=post.id)}}">Edit Post</a>
                <form id="delete-form" action="{{ url_for('forum.delete_post', post_id=post.id) }}" method="post" style="display:inline;">
                    <input type="hidden" name="confirm" value="1">
                </form>
                <a href="#" class="delete-option" onclick="confirmDelete()">Delete Post</a>
                {% else %}
                <a href="{{url_for('forum.report_post',post_id=post.id)}}">Report</a>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="post-detail-container">
        <h1 class="post-detail-title">{{ post.title }}</h1>

        <div class="post-detail-content">
            <p>{{post.content }}</p>
            {% if post.media_url %}
                {% set _m = post.media_url.lower() %}
                {% if _m.endswith('.png') or _m.endswith('.jpg') or _m.endswith('.jpeg') or _m.endswith('.gif') %}
                    <img class="post-media" src="{{post.media_url}}" alt="post image"/>
                {% else %}
                    <video class="post-media" controls>
                        <source src="{{post.media_url}}">
                    </video>
                {% endif %}
            {% endif %}
        </div>

        <div class="post-detail-tags">
            {% for t in post.tags %}
                <a class="post-detail-tag" href="{{url_for('forum.homepage')}}?tag={{t.name}}">#{{t.name}}</a>
            {% endfor %}
        </div>
    </div>

    <footer class="post-detail-actions">
        <button type="button" class="post-detail-button" data-id="{{ post.id }}">
            üëçüèª<span class="like-count">{{ post.like_count()}}</span>
        </button>

        <button type="button" class="post-detail-button"
            onclick='window.location.href="{{ url_for("forum.post_detail", post_id=post.id) }}#comments"'>
            üí¨<span class="comment-count">{{ post.comment_count()}}</span>
        </button>

        <button type="button" class="post-detail-button" data-url="{{ url_for('forum.post_detail', post_id=post.id, _external=True) }}">
            <span class="icon">üîó</span><span class="label">Share</span>
        </button>
    </footer>
</article>

<section class="card comments-section">
    <h3 class="comment-title">Comments</h3>
    <form class="comment-form" id="comment-form" action="{{url_for('forum.add_comment',post_id=post.id)}}" method="post">
        <img src="{{url_for('static',filename='avatar'~(author_profile.avatar_type if author_profile else 0)~'.png')}}"alt="avatar" class="comment-avatar">
        <textarea name="body" class="comment-input" rows="1" placeholder="Write your comment here..." required></textarea>
        <button class="comment-submit" type="submit">Submit</button>
    </form>

    <ul class="comment-list">
    {% for c in post.comments %}
    <li class="comment-item">
        <img src="{{url_for('static',filename='avatar' ~ (c.profile.avatar_type if c.profile else 0) ~ '.png')}}" alt="avatar" class="comment-avatar">
        <div class="comment-content">
            <div class="comment-header">
                <span class="comment-author">{{c.profile.faculty_name if c.profile else 'Anonymous'}}</span>
                {% if c.user_id == post.user_id %}
                <span class="author-badge">Author</span>
                {% endif %}
            </div>
            <p class="comment-text">{{c.body}}</p>
            <div class="comment-time">{{c.created_at.strftime('%Y-%m-%d %H:%M')}}</div>
            <div class="comment-actions">
                <span class="comment-action">Like</span>
                <span class="comment-action">Reply</span>
            </div>
        </div>
    </li>
    {% endfor %}
    </ul>
</section>

<script>
   document.getElementById("comment-form").addEventListener("submit", async function(e) {
    e.preventDefault(); 
    const formData = new FormData(this);
    try {
        const res = await fetch(this.action, { method: "POST", body: formData });
        const data = await res.json();
        if (data.ok) {
            const commentList = document.querySelector(".comment-list");
            const li = document.createElement("li");
            li.classList.add("comment-item");
            li.innerHTML = `
                <img src="/static/avatar0.png" alt="avatar" class="comment-avatar">
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">${data.author || "Anonymous"}</span>
                    </div>
                    <p class="comment-text">${formData.get("body")}</p>
                    <div class="comment-time">just now</div>
                </div>
            `;
            commentList.prepend(li);

            const countSpan = document.querySelector(".comment-count");
            if (countSpan) {
                countSpan.textContent = data.total_comment;
            }

            this.reset();
        } else {
            alert(data.error);
        }
    } catch (err) {
        console.error(err);
        alert("Network error while commenting.");
    }
});
    
    socket.on("new_comment", function(data) {
    if (data.post_id === parseInt("{{ post.id }}")) {
        const commentList = document.querySelector(".comment-list");

        const li = document.createElement("li");
        li.classList.add("comment-item");
        li.innerHTML = `
            <img src="/static/avatar${data.avatar_type || 0}.png" alt="avatar" class="comment-avatar">
            <div class="comment-content">
                <div class="comment-header">
                    <span class="comment-author">${data.author || "Anonymous"}</span>
                </div>
                <p class="comment-text">${data.body}</p>
                <div class="comment-time">just now</div>
            </div>
        `;
        commentList.prepend(li);

        const countSpan = document.querySelector(".comment-count");
        if (countSpan) {
            countSpan.textContent = data.total_comment; 
        }
    }
});


    document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".like-btn").forEach(button => {
        button.addEventListener("click", () => {
            const postId = button.getAttribute("data-id");

            fetch(`/forum/post/${postId}/like`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({})
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    const countSpan = button.querySelector(".like-count");
                    if (countSpan) countSpan.textContent = data.likes;
                } else {
                    alert(data.error || "Like failed.");
                }
            })
            .catch(err => console.error("Like error:", err));
        });
    });

    if (typeof io !== "undefined") {
        const socket = io();
        socket.on("like_updates", function(data) {
            const buttonEl = document.querySelector(`.like-btn[data-id="${data.post_id}"]`);
            if (buttonEl) {
                const countSpan = buttonEl.querySelector(".like-count");
                if (countSpan) countSpan.textContent = data.likes;
            }
        });
    }
});

    function confirmDelete() {
    if (confirm("Are you sure you want to delete this post? This action cannot be undone.")) {
        document.getElementById("delete-form").submit();
    }
}

</script>
</body>
</html>