<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <script src="/socket.io/socket.io.js"></script>
    <title>MMU FORUM</title>
</head>
<body>
<article class="card post">
    <header class="post-header">
        <div style="display: flex; align-items: center;gap: 10px;">
            <img src="{{url_for('static', filename='avatar' ~ (author_profile.avatar_type if author_profile else 0) ~ '.png')}}" 
            alt="avatar" style="width: 40px; height:40px; border-radius: 50%; object-fit: cover;">
            <div style="display:flex;flex-direction: column;gap:2px;" >
                <span class="post-author">
                    {{author_profile.degree_name if author_profile else ''}} {{author_profile.faculty_name if author_profile else 'Anonymous'}}
                </span>
                <span class="post-timestamp">
                    {{post.created_at.strftime('%Y-%m-%d %H:%M')}}
                </span>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropdown-toggle">‚ãÆ</button>
            <div class="dropdown-menu">
                {% if session.get("user_id") == post.user_id %}
                <a href="{{url_for('forum.edit_post', post_id=post.id)}}">Edit Post</a>
                <form id="delete-form" action="{{ url_for('forum.delete_post', post_id=post.id) }}" method="post" style="display:inline;">
                    <input type="hidden" name="confirm" value="1">
                </form>
                <a href="#" class="delete-option" onclick="confirmDelete()">Delete Post</a>
                {% else %}
                <a href="{{url_for('forum.report_post',post_id=post.id)}}">Report</a>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="post-detail-container">
        <h1 class="post-detail-title">{{ post.title }}</h1>

        <div class="post-detail-content">
            <p>{{post.content }}</p>
            {% for m in post.media %}
            {% if m.media_url.endswith('.png') or m.media_url.endswith('.jpg') or m.media_url.endswith('.jpeg') or m.media_url.endswith('.gif') %}
                    <img class="media" src="{{url_for('static',filename=m.media_url)}}" alt="post image"/>
                {% else %}
                    <video class="media" controls>
                        <source src="{{url_for('static',filename=m.media_url)}}">
                    </video>
            {% endif %}
            {% endfor %}
        </div>

        <div class="post-detail-tags">
            {% for t in post.tags %}
                <a class="post-detail-tag" href="{{url_for('forum.homepage')}}?tag={{t.name}}">#{{t.name}}</a>
            {% endfor %}
        </div>
    </div>

    <footer class="post-detail-actions">
        <button type="button" class="post-detail-button like-btn" data-id="{{ post.id }}">
            üëçüèª<span class="like-count">{{ post.like_count()}}</span>
        </button>

        <button type="button" class="post-detail-button comment-btn"
            data-href="{{ url_for('forum.post_detail', post_id=post.id) }}#comments">
            üí¨<span class="comment-count">{{ post.comment_count()}}</span>
        </button>
    </footer>
</article>

<section class="card comments-section">
    <h3 class="comment-title">Comments</h3>
    <form class="comment-form" id="comment-form" action="{{url_for('forum.add_comment',post_id=post.id)}}" method="post" enctype="multipart/form-data">
        <img src="{{url_for('static',filename='avatar'~(author_profile.avatar_type if author_profile else 0)~'.png')}}"alt="avatar" class="comment-avatar">
        <textarea name="body" class="comment-input" rows="1" placeholder="Write your comment here..." required></textarea>
        <button class="comment-submit" type="submit">Submit</button>
    </form>

    <ul class="comment-list">
    {% for c in post.comments %}
    <li class="comment-item" >
        <img src="{{url_for('static',filename='avatar' ~ (c.profile.avatar_type if c.profile else 0) ~ '.png')}}" alt="avatar" class="comment-avatar">
        <div class="comment-content">
            <div class="comment-header">
                <span class="comment-author" data-author="{{c.author}}">{{c.profile.faculty_name if c.profile else 'Anonymous'}}</span>
                {% if c.user_id == post.user_id %}
                <span class="author-badge">Author</span>
                {% endif %}
            </div>
            <p class="comment-text">{{c.body}}</p>
            <div class="comment-time">{{c.created_at.strftime('%Y-%m-%d %H:%M')}}</div>
            <div class="comment-actions">
                <button class="like-comment-btn" data-id="{{c.id}}">
                    üëç<span class="comment-like-count">{{c.like_count()}}</span>
                </button>
                <!--
                <span class="comment-action reply-btn" data-id="{{c.id}}">Reply</span>
              -->
            </div>

            <div class="replies">
                {% for r in c.replies %}
                <div class="reply-item" data-id="{{r.id}}">
                    <div class="reply-header">
                        <img src="{{url_for('static',filename='avatar' ~ (c.profile.avatar_type if c.profile else 0) ~ '.png')}}" alt="avatar" class="comment-avatar">
                        <span class="reply-author">{{r.profile.faculty_name if r.profile else 'Anonymous'}}</span>
                    </div>
                    <div class="reply-body">{{r.body}}</div>
                    <div class="comment-time">{{r.created_at.strftime('%Y-%m-%d %H:%M')}}</div>
                    <div class="reply-actions">
                        <button class="like-reply-btn" data-id="{{r.id}}">
                            üëç<span class="reply-like-count">{{r.like_count()}}</span>
                        </button>
                        <!--
                        <span class="comment-action reply-btn" data-id="{{r.id}}">Reply</span>
                        -->
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </li>
    {% endfor %}
    </ul>
</section>
<!--
<div id="reply-form" style="display: none;">
  <form id="replyForm" data-post-id="{{ post.id }}">
    <input type="hidden" name="parent_id" id="replyParentId">
    <textarea name="body" placeholder="Write your reply..."></textarea>
    <button type="submit">Submit</button>
  </form>
</div>
-->

<script>
document.addEventListener("DOMContentLoaded", () => {
  // -------------------- SOCKET.IO --------------------
  let socket = null;
  if (typeof io !== "undefined") {
    socket = io();

    socket.on("like_updates", data => {
      const buttonEl = document.querySelector(`.like-btn[data-id="${data.post_id}"]`);
      if (buttonEl) {
        const countSpan = buttonEl.querySelector(".like-count");
        if (countSpan) countSpan.textContent = data.likes;
      }
    });

    socket.on("new_comment", data => {
      if (data.parent_id) {
        if (!document.querySelector(`.reply-item[data-id="${data.comment_id}"]`)) {
          addReplyToComment(data);
        }
      } else {
        if (!document.querySelector(`.comment-item[data-id="${data.comment_id}"]`)) {
          addCommentToList(data);
        }
      }
    });
  }

  // -------------------- POST LIKE --------------------
  document.querySelectorAll(".like-btn").forEach(button => {
    button.addEventListener("click", async () => {
      const postId = button.dataset.id;
      try {
        const res = await fetch(`/forum/post/${postId}/like`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        const data = await res.json();
        if (data.ok) {
          const countSpan = button.querySelector(".like-count");
          if (countSpan) countSpan.textContent = data.likes;
        } else {
          alert(data.error || "LIKE ERROR");
        }
      } catch (err) {
        console.error("LIKE ERROR:", err);
        alert("Network error, please try again later");
      }
    });
  });

  // -------------------- NAVIGATION BUTTONS --------------------
  document.querySelectorAll("[data-href]").forEach(btn => {
    btn.addEventListener("click", () => {
      window.location.href = btn.dataset.href;
    });
  });

  // -------------------- COMMENT FORM --------------------
  const commentForm = document.getElementById("comment-form");
  if (commentForm) {
    commentForm.addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(commentForm);

      try {
        const res = await fetch(commentForm.action, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (data.ok) {
          if (!document.querySelector(`.comment-item[data-id="${data.comment_id}"]`)) {
            addCommentToList(data);
          }
          commentForm.reset();
        } else {
          alert(data.error || "Comment Failed");
        }
      } catch (err) {
        console.error("Comment Failed:", err);
        alert("Network error, please try again later");
      }
    });
  }

  // -------------------- REPLY FORM --------------------
  /*
  const replyFormContainer = document.getElementById("reply-form");
  const replyForm = document.getElementById("replyForm");
  const parentInput = document.getElementById("replyParentId");

  document.addEventListener("click", async e => {
    // LIKE COMMENT/REPLY
    const likeBtn = e.target.closest(".like-comment-btn, .like-reply-btn");
    if (likeBtn) {
      const commentId = likeBtn.dataset.id;
      try {
        const res = await fetch(`/forum/comment/${commentId}/like`, { method: "POST" });
        const data = await res.json();
        if (data.ok) {
          const countSpan = likeBtn.querySelector("span");
          if (countSpan) countSpan.textContent = data.likes;
        }
      } catch (err) {
        console.error("Like and Comment Error:", err);
      }
    }

    // SHOW REPLY FORM
    const replyBtn = e.target.closest(".reply-btn");
    if (replyBtn) {
      const commentId = replyBtn.dataset.id;
      parentInput.value = commentId;

      const authorEl = replyBtn.closest(".comment-item, .reply-item")
                              .querySelector(".comment-author, .reply-author");
      const textarea = replyForm.querySelector("textarea");
      textarea.value = `@${authorEl?.textContent || "Anonymous"} `;
      textarea.focus();

      replyBtn.closest(".comment-item, .reply-item").appendChild(replyFormContainer);
      replyFormContainer.style.display = "block";
    }
  });

  // SUBMIT REPLY
  if (replyForm) {
    replyForm.addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(replyForm);
      const postId = replyForm.dataset.postId;

      try {
        const res = await fetch(`/forum/post/${postId}/comment`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (data.ok) {
          if (!document.querySelector(`.reply-item[data-id="${data.comment_id}"]`)) {
            addReplyToComment(data);
          }
          replyForm.reset();
          replyFormContainer.style.display = "none";
        } else {
          alert(data.error || "Reply Failed");
        }
      } catch (err) {
        console.error("Reply Error:", err);
        alert("Network error, please try again later");
      }
    });
  }
  */

  // -------------------- HELPER FUNCTIONS --------------------
  function addCommentToList(data) {
    const commentList = document.querySelector(".comment-list");
    if (!commentList) return;

    const li = document.createElement("li");
    li.className = "comment-item";
    li.dataset.id = data.comment_id;

    li.innerHTML = `
      <img src="/static/avatar${data.avatar_type || 0}.png" alt="avatar" class="comment-avatar">
      <div class="comment-content">
        <div class="comment-header">
          <span class="comment-author">${data.author}</span>
          ${data.is_author ? '<span class="author-badge">Author</span>' : ''}
        </div>
        <p class="comment-text">${data.body}</p>
        <div class="comment-time">${data.created_at || "Just Now"}</div>
        <div class="comment-actions">
          <button class="like-comment-btn" data-id="${data.comment_id}">
            üëç <span class="comment-like-count">${data.likes || 0}</span>
          </button>
          <span class="reply-btn" data-id="${data.comment_id}">Reply</span>
        </div>
        <div class="replies"></div>
      </div>
    `;

    commentList.appendChild(li);
  }

  function addReplyToComment(data) {
    const parentComment = document.querySelector(
      `.comment-item[data-id="${data.parent_id}"] .replies`
    );
    if (!parentComment) return;

    const div = document.createElement("div");
    div.className = "reply-item";
    div.dataset.id = data.comment_id;

    div.innerHTML = `
      <div class="reply-header">
        <img src="/static/avatar${data.avatar_type || 0}.png" alt="avatar" class="comment-avatar">
        <span class="reply-author">${data.author}</span>
        ${data.is_author ? '<span class="author-badge">Author</span>' : ''}
      </div>
      <div class="reply-body">${data.body}</div>
      <div class="comment-time">${data.created_at || "Just Now"}</div>
      <div class="reply-actions">
        <button class="like-reply-btn" data-id="${data.comment_id}">
          üëç <span class="reply-like-count">${data.likes || 0}</span>
        </button>
        <span class="reply-btn" data-id="${data.comment_id}">Reply</span>
      </div>
    `;

    parentComment.appendChild(div);
  }
});

function confirmDelete() {
  if (confirm("Are you sure you want to delete this post? This action cannot be undone")) {
    document.getElementById("delete-form").submit();
  }
}
</script>

</body>
</html>